version: 2

workflows:
  version: 2
  build-master:
    jobs:
      - test:
          filters:
            branches:
              only: master
  build-other-branches:
    jobs:
      - test:
          filters:
            branches:
              ignore: master

jobs:
  test:
    docker:
      - image: node:12.16.1
    steps:
      - checkout
      - run: |
          apt-get update && apt-get dist-upgrade
          apt-get install --no-cache git openssh make gcc g++ python
      - run:
          name: Install Docker Compose
          command: |
            set -x
            curl -L https://github.com/docker/compose/releases/download/1.25.3/docker-compose-`uname -s`-`uname -m` > /usr/local/bin/docker-compose
            chmod +x /usr/local/bin/docker-compose
      - setup_remote_docker
      - run:
          name: Install Dev Dependencies
          command: npm install
      - run:
          name: Run Linter
          command: npm run lint
      - run:
          name: Bootstrap Lerna
          command: npm run lerna-reset
      - run:
          name: Run Unit Tests
          command: npm run test
      - run:
          name: Start elixir-omg Environment
          command: |
            mkdir -p ~/.ssh/
            echo -e "Host github.com\n\tStrictHostKeyChecking no\n" > ~/.ssh/config
            git clone git@github.com:omisego/elixir-omg.git ~/elixir-omg
            cd ~/elixir-omg
            SNAPSHOT=SNAPSHOT_MIX_EXIT_PERIOD_SECONDS_120 make init_test
            docker-compose up
